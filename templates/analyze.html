{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="mb-4">
            <h2 class="card-title">Analyze Transactions</h2>
            <div class="d-flex justify-content-between align-items-center">
                <h5>File: {{ file.filename }}</h5>
                <div class="form-group" style="width: 300px;">
                    <label for="bank_account" class="form-label">Select Bank Account</label>
                    <select class="form-select" id="bank_account" name="bank_account">
                        <option value="">Select Bank Account</option>
                        {% for account in accounts %}
                            {% if account.category.lower() == 'bank' or 'bank' in account.name.lower() %}
                                <option value="{{ account.id }}" 
                                        {% if bank_account_id == account.id %}selected{% endif %}>
                                    {{ account.link }}:{{ account.name }} {% if account.sub_category %}({{ account.sub_category }}){% endif %}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        {% if transactions %}
        <form method="POST" id="analyzeForm">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Explanation</th>
                            <th>Analysis</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ transaction.description }}</td>
                            <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                ${{ "%.2f"|format(transaction.amount) }}
                            </td>
                            <td>
                                <input type="text" 
                                       class="form-control explanation-input" 
                                       name="explanation_{{ transaction.id }}" 
                                       value="{{ transaction.explanation }}"
                                       placeholder="Enter explanation">
                            </td>
                            <td>
                                <select class="form-select analysis-select" 
                                        name="analysis_{{ transaction.id }}"
                                        data-transaction-id="{{ transaction.id }}">
                                    <option value="">Select Account</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.id }}" 
                                            {% if transaction.account_id == account.id %}selected{% endif %}>
                                        {{ account.link }}:{{ account.name }} {% if account.sub_category %}({{ account.sub_category }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
        {% else %}
        <div class="alert alert-info">
            No transactions found in this file.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analyzeForm');
    const explanationInputs = document.querySelectorAll('.explanation-input');
    const analysisSelects = document.querySelectorAll('.analysis-select');
    
    // Handle bank account selection
    const bankAccountSelect = document.getElementById('bank_account');
    if (bankAccountSelect) {
        bankAccountSelect.addEventListener('change', function() {
            form.submit();
        });
    }
    
    // Handle explanation changes
    explanationInputs.forEach(input => {
        input.addEventListener('change', function() {
            form.submit();
        });
    });
    
    // Handle analysis changes
    analysisSelects.forEach(select => {
        select.addEventListener('change', function() {
            form.submit();
        });
    });
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Bank Statement Upload{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Upload Bank Statement</h2>

    <!-- Format Requirements Card -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">File Format Requirements</h5>
            <ul class="mb-0">
                <li>File Format: Excel (.xlsx) or CSV</li>
                <li>Required Columns:
                    <ul>
                        <li>Date (transaction date)</li>
                        <li>Description (transaction details)</li>
                        <li>Amount (debit/credit amount)</li>
                    </ul>
                </li>
                <li>Bank Account Selection:
                    <ul>
                        <li>Must select an existing bank account</li>
                        <li>Account must start with "ca.810"</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <!-- Upload Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="bankStatementUploadForm">
                {{ form.csrf_token }}

                <div class="mb-3">
                    {{ form.bank_account.label(class="form-label") }}
                    {{ form.bank_account(class="form-select") }}
                    {% if form.bank_account.description %}
                        <div class="form-text">{{ form.bank_account.description }}</div>
                    {% endif %}
                    {% if not form.bank_account.choices %}
                        <div class="alert alert-warning mt-2">
                            <small>No bank accounts found. Please add a bank account (starting with ca.810) in settings first.</small>
                        </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    {{ form.statement_file.label(class="form-label") }}
                    {{ form.statement_file(class="form-control", accept=".csv,.xlsx") }}
                    <div class="form-text">
                        Upload bank statement in CSV or Excel format. Must contain Date, Description, and Amount columns.
                    </div>
                </div>

                <!-- Upload Progress -->
                <div class="progress mb-3 d-none" id="uploadProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100">0%</div>
                </div>

                <!-- Status Display -->
                <div id="uploadStatus" class="alert d-none mb-3">
                    <p class="mb-1"><strong>Status:</strong> <span id="statusText">Processing...</span></p>
                    <p class="mb-1"><small>Processed: <span id="processedRows">0</span> / <span id="totalRows">0</span> rows</small></p>
                    <p class="mb-0"><small>Time remaining: <span id="timeRemaining">Calculating...</span></small></p>
                </div>

                <!-- Error Display -->
                <div id="errorContainer" class="alert alert-danger d-none mb-3">
                    <h6 class="alert-heading">Upload Errors:</h6>
                    <ul id="errorList" class="mb-0">
                    </ul>
                </div>

                <button type="submit" class="btn btn-primary" id="submitButton">Upload Bank Statement</button>
            </form>
        </div>
    </div>

    <!-- Recent Uploads -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Recent Bank Statement Uploads</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Upload Date</th>
                            <th>Bank Account</th>
                            <th>Statement Period</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_uploads %}
                            {% for upload in recent_uploads %}
                            <tr>
                                <td>{{ upload.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>{{ upload.bank_account.name }}</td>
                                <td>{{ upload.statement_period }}</td>
                                <td>
                                    <span class="badge bg-{{ upload.status_color }}">
                                        {{ upload.status }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('bank_statements.view_statement', upload_id=upload.id) }}" 
                                       class="btn btn-sm btn-primary">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center">No bank statements uploaded yet.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bankStatementUploadForm');
    const progressBar = document.querySelector('.progress-bar');
    const progressDiv = document.getElementById('uploadProgress');
    const statusDiv = document.getElementById('uploadStatus');
    const statusText = document.getElementById('statusText');
    const processedRows = document.getElementById('processedRows');
    const totalRows = document.getElementById('totalRows');
    const timeRemaining = document.getElementById('timeRemaining');
    const errorContainer = document.getElementById('errorContainer');
    const errorList = document.getElementById('errorList');
    const submitButton = document.getElementById('submitButton');
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

    form.onsubmit = async function(e) {
        e.preventDefault();

        // Reset display elements
        errorContainer.classList.add('d-none');
        errorList.innerHTML = '';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.classList.remove('bg-danger');

        const formData = new FormData(form);

        // Show progress elements
        progressDiv.classList.remove('d-none');
        statusDiv.classList.remove('d-none');
        submitButton.disabled = true;

        try {
            const response = await fetch('{{ url_for("bank_statements.upload") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Upload failed: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                statusText.textContent = 'Upload Complete!';
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                setTimeout(() => window.location.reload(), 2000);
            } else {
                throw new Error(result.error || 'Upload failed');
            }

        } catch (error) {
            console.error('Upload error:', error);
            statusText.textContent = error.message;
            errorContainer.classList.remove('d-none');
            errorList.innerHTML = `<li>${error.message}</li>`;
            progressBar.classList.add('bg-danger');
        } finally {
            submitButton.disabled = false;
        }
    };
});
</script>
{% endblock %}